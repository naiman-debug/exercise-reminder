# 强制设计文档检查规则

**优先级:** 最高 - 超越所有其他规则

## 规则

在任何代码修改前，必须执行以下检查：

### 1. 设计文档存在性检查

```python
# 伪代码
def before_any_code_change():
    design_docs = find_design_docs()
    if not design_docs:
        ask_user("是否存在设计文档？如果存在，请提供路径")
    return design_docs
```

### 2. 强制阅读设计文档

```python
def read_design_doc(doc_path):
    """
    必须完整阅读，不得跳过
    """
    content = read_file(doc_path)
    # 必须从头读到尾
    # 记录关键设计要求
    return extract_requirements(content)
```

### 3. 设计-实现对照验证

```python
def validate_implementation():
    """
    实现完成后，对照设计文档验证
    """
    checklist = create_checklist_from_design()
    for item in checklist:
        assert item.implemented, f"设计要求未实现: {item.requirement}"
```

## 触发词列表

以下用户输入会触发强制检查：
- "执行"
- "go"
- "开始"
- "实现"
- "修复"
- "添加"
- "修改"
- "更新"
- "重构"
- 任何暗示代码操作的指令

## 处理流程

```
用户输入 → 触发词检测
    ↓
是触发词？
├─ 是 → 强制设计检查流程
│     ├─ 查找设计文档
│     ├─ 阅读设计文档
│     ├─ 创建 checklist
│     └─ 等待用户确认
│
└─ 否 → 正常处理
```

## 检查结果输出

```markdown
## 设计文档检查报告

**检查时间:** 2026-01-27 12:00:00

### 找到设计文档
- [DESIGN-UI-001.md](docs/DESIGN-UI-001.md) - UI设计规范

### 关键设计要求提取

#### 向导设计
- 页面数: 3页
- 第1页: 个人基础设置
- 第2页: 提醒设置
- 第3页: 体验倒计时

#### 弹窗设计
- 站立弹窗: 无边框，60%x50%
- 微运动弹窗: 有标题栏，800x600
- 远眺弹窗: 无边框，50%x40%

#### 倒计时设计
- >50%: 绿色 #4CAF50
- 30-50%: 黄色 #FFC107
- 10-30%: 橙色 #FF9800
- <10秒: 红色 #F44336 + 闪烁动画

### 待实现任务映射

| 设计要求 | 需要修改的文件 | 状态 |
|---------|--------------|------|
| 向导3页 | src/ui/wizards/first_run_wizard.py | 待修改 |
| 微运动标题栏 | src/ui/dialogs/exercise_dialog.py | 待修改 |
| 倒计时闪烁 | src/ui/dialogs/base_dialog.py | 待添加 |

**请确认是否继续执行？**
```

## 执行阻塞

```
在设计检查完成前，不得执行任何代码修改
```

## 例外情况

**只有以下情况可以跳过设计检查：**

1. **测试文件修改**
   - 单纯的测试添加
   - 测试bug修复

2. **文档修改**
   - README、注释等

3. **用户明确跳过**
   - 用户说："没有设计文档，直接实现"
   - 用户说："跳过设计检查"

## 违规后果

```
如果跳过设计检查导致设计与实现不符：
1. 必须记录偏差分析日志
2. 重新执行设计检查流程
3. 修正所有偏差
4. 创建回归测试防止再次发生
```

## 集成到 SUPERPOWER

此规则与以下技能集成：

1. **brainstorming** - 自动查找设计文档
2. **writing-plans** - 计划必须引用设计文档章节
3. **executing-plans** - 执行前验证设计文档已读

## 示例对话

### 正确流程

```
用户: "执行：修改向导页面"
AI: "检测到代码修改请求，执行强制设计检查..."
    "找到设计文档: docs/DESIGN-UI-001.md"
    "正在阅读..."
    "关键要求提取完成..."
    "设计要求: 向导应为3页"
    "当前实现: 4页"
    "需要修改: 删除欢迎页"
    "请确认是否继续？"
```

### 错误流程（已防止）

```
用户: "修改向导"
AI: 直接修改代码...
    "完成！"
用户: "设计与实现完全不符！"
AI: "重新检查设计文档..."
    "修复偏差..."
```
