# Git 自动提交推送规则（强制版）

> **项目**：exercise-reminder-v3
> **目的**：确保代码及时备份到 GitHub，防止丢失
> **强制**：所有 AI Agent 必须遵守，不可跳过

---

## 🎯 核心原则

> **"写完必须提交，提交必须审查，审查必须推送"**

这是强制规则，不允许跳过任何步骤！

---

## 📋 完整提交流程（强制执行）

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 写完代码后的强制流程                      │
└─────────────────────────────────────────────────────────────────┘

Step 1: 代码审查（使用 Skills）
   ↓
   根据代码类型选择：
   - 所有代码 → requesting-code-review
   - 后端代码 → backend-patterns
   - 安全相关 → security-review
   ↓
   只有审查通过才能继续
   ↓
Step 2: 运行测试
   ↓
   npm test && npm run typecheck
   ↓
   只有测试通过才能继续
   ↓
Step 3: Git 提交
   ↓
   git add . && git commit -m "type: 描述"
   ↓
Step 4: 推送到 GitHub
   ↓
   git push
   ↓
   ✅ 完成！代码已安全备份
```

---

## 📌 规则 1：强制代码审查（提交前必须执行）

### 何时必须审查

满足以下任一条件时，**必须先调用 Skill 审查**：

- ✅ 修改或新增了 ≥1 个代码文件
- ✅ 修复了任何 bug
- ✅ 完成了任何功能
- ✅ 重构了任何代码

### 必须使用的 Skills

| Skill | 适用场景 | 命令 |
|-------|----------|------|
| `requesting-code-review` | **所有代码**（默认） | `/skill requesting-code-review` |
| `backend-patterns` | 后端代码（数据库、IPC、API） | `/skill backend-patterns` |
| `security-review` | 安全相关（用户输入、认证、数据） | `/skill security-review` |
| `test-driven-development` | 需要测试覆盖 | `/skill test-driven-development` |

### 审查流程

```bash
# 1. 根据代码类型选择 Skill
## 方式1：使用 Skill 工具
/skill requesting-code-review

## 方式2：使用 Task 工具（更详细）
使用 requesting-code-review agent 审查本次修改

# 2. 等待审查结果
# AI 会检查：
# - 代码质量
# - 潜在 bug
# - 最佳实践
# - 安全问题

# 3. 审查通过后继续
# 如果有问题，先修复再提交
```

---

## 📌 规则 2：强制测试（提交前必须执行）

### 测试命令

```bash
# 运行所有测试
npm test

# 类型检查
npm run typecheck
```

### 通过标准

| 检查项 | 必须通过 |
|--------|----------|
| 单元测试 | 100% 通过 |
| 类型检查 | 无错误 |
| 构建验证 | 构建成功 |

### 不通过处理

```
IF 测试失败 THEN
    1. 记录失败的测试
    2. 修复问题
    3. 重新运行测试
    4. 直到全部通过
    5. ❌ 不允许跳过或标记"临时完成"
END IF
```

---

## 📌 规则 3：强制提交推送（审查+测试通过后立即执行）

### 提交命令

```bash
# 1. 添加所有修改
git add .

# 2. 提交（必须符合格式规范）
git commit -m "<type>: <描述>"

# 3. 推送到 GitHub
git push
```

### 提交信息格式

```
<type>: <简短描述>

允许的 type：
  feat   - 新功能
  fix    - Bug 修复
  docs   - 文档更新
  style  - 代码格式
  test   - 测试相关
  chore  - 构建/工具
  perf   - 性能优化
  ci     - CI 配置

示例：
  feat: 添加用户登录功能
  fix: 修复查询超时问题
  docs: 更新 README
```

---

## 📌 规则 4：会话结束前强制检查

### 触发关键词

当用户说以下任何词时，AI **必须立即执行**检查：

- "结束"、"完成"、"好了"、"再见"
- "下次继续"、"暂停"
- "关闭"、"退出"
- 会话自然结束

### 检查和执行流程

```
1. git status
   ↓
   检查是否有未提交的修改
   ↓
2. 如果有修改 → 自动执行：
   git add .
   git commit -m "chore: 会话结束前自动提交"
   git push
   ↓
3. 向用户确认：
   ✅ 代码已备份到 GitHub
   📦 提交 ID: xxx
   🔗 查看: https://github.com/.../commit/xxx
```

---

## 📌 规则 5：意外关闭恢复（新会话启动时）

### 启动时检查

每次新会话启动时，AI **必须**：

1. 执行 `git status` 检查未提交修改
2. 如果有，向用户汇报并询问是否提交
3. 用户确认后自动执行完整提交流程

---

## 📌 规则 6：推送失败处理

### 错误处理

```
情况1：网络失败
  → 自动重试 3 次（每次间隔 5 秒）
  → 仍失败 → 提示用户检查网络

情况2：冲突（有人改了同一行）
  → git pull --rebase
  → 如果冲突 → 询问用户：
     1. 保留本地修改 (git push --force)
     2. 合并远程修改后推送
  → 解决冲突后重新 push

情况3：认证失败
  → ⚠️ GitHub Token 可能过期
  → 提示用户手动处理
  → 不自动处理认证
```

---

## 🤖 AI 强制执行流程图

```
┌─────────────────────────────────────────────────────────────┐
│                  AI 完整工作流程                              │
└─────────────────────────────────────────────────────────────┘

1. 接收任务
   ↓
2. 编写/修改代码
   ↓
3. 【强制】调用代码审查 Skill
   /skill requesting-code-review
   ↓
4. 审查通过？
   ↓ NO ↓ 修复问题 → 返回步骤 2
   YES ↓
5. 【强制】运行测试
   npm test && npm run typecheck
   ↓
6. 测试通过？
   ↓ NO ↓ 修复问题 → 返回步骤 5
   YES ↓
7. 【强制】提交推送
   git add . && git commit -m "feat: xxx" && git push
   ↓
8. ✅ 完成！向用户汇报结果
```

---

## ⚠️ 强制要求（不可跳过）

| 步骤 | 强制性 | 说明 |
|------|--------|------|
| 代码审查 | 🔴 强制 | 提交前必须调用 Skill |
| 测试验证 | 🔴 强制 | 提交前必须运行测试 |
| Git 提交 | 🔴 强制 | 审查测试通过后必须提交 |
| GitHub 推送 | 🔴 强制 | 提交后必须推送 |

---

## 📝 版本历史

- **v2.0** (2026-02-01) - 强化强制版
  - 添加提交前代码审查（使用 Skills）
  - 添加强制测试验证
  - 完善错误处理流程
  - 明确强制执行机制

- **v1.0** (2026-02-01) - 初始版本
