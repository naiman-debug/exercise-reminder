# 关键文档自动更新约束规则

> **项目**：exercise-reminder-v3
> **版本**：v1.0
> **创建日期**：2026-02-01
> **优先级**：⭐⭐⭐ **最高优先级强制规则**

---

## 🎯 目的

确保项目的关键文档始终保持最新状态，文档之间保持一致性，避免文档过时导致的信息不对称。

---

## 📋 关键文档清单

### 根目录文档（3 个核心文件）

| 文档 | 职责 | 受众 | 更新频率 |
|------|------|------|----------|
| **README.md** | 项目门面，完整介绍 | 新用户、开发者 | 版本发布、重大变更 |
| **CLAUDE.md** | AI 辅助配置，开发规范 | Claude Code AI | 架构变更、新增约束 |
| **CURRENT_TASK.md** | 快速概览，当前状态 | 快速查看者 | 里程碑、每周 |

### 详细文档（docs/ 目录）

| 文档 | 职责 | 受众 | 更新频率 |
|------|------|------|----------|
| **docs/TASKS.md** | 详细任务管理 | 开发者、AI Agent | 每次任务状态变化 |

---

## 🔄 强制更新触发规则

### 规则 1：完成任务后必须同步更新 ⭐ **核心规则**

**触发条件**：
- ✅ 完成任何开发任务（编码、测试、修复）
- ✅ 完成任何设计任务（架构、UI、方案）
- ✅ 完成任何文档任务（PRD、技术方案）

**必须执行的更新流程**：

```bash
# 步骤 1：更新 docs/TASKS.md（详细）
1. 将任务从"🟡 进行中"移到"✅ 已完成"
2. 在状态变更日志中记录
3. 更新总体进度百分比

# 步骤 2：同步更新 CURRENT_TASK.md（概览）
1. 添加到"✅ 最近完成"（保留最近 5 条）
2. 清空"🔄 当前进行中"（如果完成所有）
3. 更新"📊 项目进度"部分

# 步骤 3：检查是否需要更新其他文档
- 重大功能完成 → 更新 README.md 开发路线图
- 架构变更 → 更新 CLAUDE.md
- 性能目标达成 → 更新 README.md 性能指标
```

**验证清单**：
- [ ] docs/TASKS.md 已更新
- [ ] CURRENT_TASK.md 已同步
- [ ] 进度百分比一致
- [ ] 状态变更日志已记录

---

### 规则 2：开始新任务时必须更新状态 ⭐ **核心规则**

**触发条件**：
- ✅ 从"待开始"开始执行任务
- ✅ 创建新的开发任务

**必须执行的更新流程**：

```bash
# 步骤 1：更新 docs/TASKS.md（详细）
1. 将任务从"🔴 待开始"移到"🟡 进行中"
2. 添加进度百分比（如"进度: 20%"）
3. 在状态变更日志中记录

# 步骤 2：同步更新 CURRENT_TASK.md（概览）
1. 更新"🔄 当前进行中"部分
2. 更新"📊 项目进度"部分

# 步骤 3：检查依赖任务
- 检查是否有阻塞任务
- 如有阻塞，移到"🟠 等待条件"
```

**验证清单**：
- [ ] docs/TASKS.md 状态已更新
- [ ] CURRENT_TASK.md 已同步
- [ ] 进度百分比已设置
- [ ] 状态变更日志已记录

---

### 规则 3：重大变更后必须关联更新 ⭐ **核心规则**

**触发条件**：
- ✅ 技术栈变更（添加/删除依赖）
- ✅ 架构重大调整
- ✅ 性能目标变更
- ✅ 开发流程改进

**必须执行的更新流程**：

```bash
# 步骤 1：判断影响范围
- 技术栈变更 → README.md + CLAUDE.md
- 架构变更 → README.md + CLAUDE.md + 技术方案.md
- 性能目标变更 → README.md + CLAUDE.md
- 流程改进 → CLAUDE.md + constraints/README.md

# 步骤 2：依次更新所有受影响文档
- 更新技术栈部分
- 更新性能指标
- 更新约束条件
- 更新开发路线图

# 步骤 3：验证文档一致性
- 确认所有文档中相同信息一致
- 确认链接正确
- 确认版本号统一
```

**验证清单**：
- [ ] 识别所有受影响文档
- [ ] 依次更新所有文档
- [ ] 验证信息一致性
- [ ] 验证链接有效性

---

## 🔗 关联更新矩阵

### 文档依赖关系图

```
README.md
├── 技术栈 → 同步到 CLAUDE.md
├── 性能目标 → 同步到 CLAUDE.md
├── 开发路线图 → 同步到 CURRENT_TASK.md
└── 项目结构 → 同步到 CLAUDE.md

CLAUDE.md
├── 技术栈 → 同步到 README.md
├── 项目约束 → 同步到 constraints/README.md
└── 架构要点 → 同步到 README.md

CURRENT_TASK.md
├── 当前任务 → 从 docs/TASKS.md 提取
├── 最近完成 → 从 docs/TASKS.md 提取
└── 项目进度 → 从 docs/TASKS.md 计算

docs/TASKS.md
├── 进行中任务 → 同步到 CURRENT_TASK.md
├── 已完成任务 → 同步到 CURRENT_TASK.md
└── 总体进度 → 同步到 CURRENT_TASK.md
```

### 更新触发表

| 变更类型 | README.md | CLAUDE.md | CURRENT_TASK.md | docs/TASKS.md |
|----------|-----------|-----------|-----------------|--------------|
| **完成任务** | - | - | ✅ 必须更新 | ✅ 必须更新 |
| **开始任务** | - | - | ✅ 必须更新 | ✅ 必须更新 |
| **技术栈变更** | ✅ 必须更新 | ✅ 必须更新 | - | - |
| **架构变更** | ✅ 必须更新 | ✅ 必须更新 | - | - |
| **性能目标变更** | ✅ 必须更新 | ✅ 必须更新 | - | - |
| **里程碑完成** | ✅ 更新路线图 | - | ✅ 更新进度 | ✅ 更新进度 |
| **版本发布** | ✅ 更新版本号 | ✅ 更新版本号 | ✅ 更新状态 | - |

---

## 🤖 自动化 Hook 规则

### Hook 1：任务完成自动同步

**规则文件**：`.claude/hookify.task-sync-on-complete.local.md`

```yaml
enabled: true
trigger:
  event: "检测到任务完成关键词"
  keywords:
    - "完成"
    - "已完成"
    - "finished"
    - "done"
    - "完成开发"
    - "实现完成"

action:
  - "提醒更新 docs/TASKS.md"
  - "提醒同步 CURRENT_TASK.md"
  - "询问是否更新 README.md 开发路线图"

message: |
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✅ 任务完成检测！

  检测到您已完成一个任务。

  必须执行的操作：
  1. ✅ 更新 docs/TASKS.md（移到已完成）
  2. ✅ 同步 CURRENT_TASK.md（添加到最近完成）
  3. ❓ 是否更新 README.md 开发路线图？

  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### Hook 2：任务开始自动同步

**规则文件**：`.claude/hookify.task-sync-on-start.local.md`

```yaml
enabled: true
trigger:
  event: "检测到任务开始关键词"
  keywords:
    - "开始"
    - "开始开发"
    - "正在实现"
    - "执行任务"
    - "start"

action:
  - "提醒更新 docs/TASKS.md"
  - "提醒同步 CURRENT_TASK.md"

message: |
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  🔄 任务开始检测！

  检测到您开始了一个新任务。

  必须执行的操作：
  1. ✅ 更新 docs/TASKS.md（移到进行中，设置进度）
  2. ✅ 同步 CURRENT_TASK.md（更新当前进行中）

  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### Hook 3：技术栈变更自动关联

**规则文件**：`.claude/hookify.tech-stack-sync.local.md`

```yaml
enabled: true
trigger:
  event: "检测到依赖变更"
  patterns:
    - "package.json 变更"
    - "添加依赖"
    - "移除依赖"
    - "升级依赖"
    - "npm install"

action:
  - "提醒更新 README.md 技术栈"
  - "提醒同步 CLAUDE.md 技术栈"
  - "询问是否更新技术方案文档"

message: |
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  📦 技术栈变更检测！

  检测到依赖或技术栈变更。

  必须执行的操作：
  1. ✅ 更新 README.md 技术栈表格
  2. ✅ 同步 CLAUDE.md 技术栈详情
  3. ❓ 是否需要更新技术方案文档？

  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### Hook 4：会话结束前检查文档一致性

**规则文件**：`.claude/hookify.doc-consistency-check.local.md`

```yaml
enabled: true
trigger:
  event: "会话结束前"
  timing: "session_end"

action:
  - "检查 docs/TASKS.md 和 CURRENT_TASK.md 一致性"
  - "检查是否有进行中任务未记录"
  - "提醒更新状态变更日志"

message: |
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  📋 文档一致性检查！

  会话即将结束，检查以下内容：

  检查项：
  1. docs/TASKS.md 和 CURRENT_TASK.md 是否一致？
  2. 进行中任务是否已记录？
  3. 状态变更日志是否完整？
  4. 进度百分比是否准确？

  如发现问题，请立即修正！

  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## ✅ 验证机制

### 自动验证检查清单

在完成任何任务后，AI Agent **必须**执行以下验证：

```bash
# 验证 1：文档存在性
- [ ] README.md 存在
- [ ] CLAUDE.md 存在
- [ ] CURRENT_TASK.md 存在
- [ ] docs/TASKS.md 存在

# 验证 2：任务状态同步
- [ ] docs/TASKS.md 状态正确
- [ ] CURRENT_TASK.md 已同步
- [ ] 进度百分比一致

# 验证 3：链接有效性
- [ ] README.md 中的文档链接有效
- [ ] CLAUDE.md 中的全局配置链接有效
- [ ] CURRENT_TASK.md 中的相关文档链接有效

# 验证 4：信息一致性
- [ ] 技术栈在 README.md 和 CLAUDE.md 中一致
- [ ] 性能目标在 README.md 和 CLAUDE.md 中一致
- [ ] 项目进度在 CURRENT_TASK.md 和 TASKS.md 中一致
```

### 不一致检测

如果检测到文档不一致，AI Agent **必须**：

```markdown
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 文档不一致警告！

检测到以下不一致：

❌ [具体描述不一致的地方]

建议修复方案：
1. [方案 1]
2. [方案 2]

是否立即修复？

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

请回答：是 / 否 / 稍后
```

---

## 🚨 强制执行机制

### Pre-commit Hook 检查

在 Git 提交前，自动检查关键文档：

```bash
#!/bin/bash
# .git/hooks/pre-commit

echo "🔍 检查关键文档一致性..."

# 检查 1：文档存在
if [ ! -f "README.md" ] || [ ! -f "CLAUDE.md" ] || [ ! -f "CURRENT_TASK.md" ]; then
  echo "❌ 缺少关键文档！"
  echo "必须存在：README.md, CLAUDE.md, CURRENT_TASK.md"
  exit 1
fi

# 检查 2：TASKS.md 和 CURRENT_TASK.md 同步
# （这里可以添加更复杂的检查逻辑）

echo "✅ 文档检查通过"
```

### AI Agent 强制规则

所有 AI Agent 在以下时刻**必须**检查文档状态：

1. **完成任务时**：检查并更新 TASKS.md + CURRENT_TASK.md
2. **开始任务时**：检查并更新 TASKS.md + CURRENT_TASK.md
3. **会话结束时**：检查所有文档一致性
4. **Git 提交前**：验证文档状态

---

## 📊 更新记录模板

### 文档变更日志

每次更新关键文档时，必须在文档末尾添加变更记录：

```markdown
---

## 📝 变更日志

| 日期 | 变更内容 | 变更原因 | 影响文档 |
|------|----------|----------|----------|
| 2026-02-01 | 初始创建 | 建立文档体系 | - |
| YYYY-MM-DD | [描述] | [原因] | [列出影响的文档] |
```

---

## 🔗 相关文档

- **约束索引**：`constraints/README.md`
- **工作流恢复**：`constraints/workflow-recovery.md`
- **任务看板**：`docs/TASKS.md`
- **当前任务**：`CURRENT_TASK.md`
- **全局规范**：`F:\claude-code\AGENTS.md`

---

## 📝 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.0 | 2026-02-01 | 初始版本，建立文档自动更新约束 |

---

> ⚠️ **重要提示**：这些规则是**强制性的**，不是可选项！
>
> 所有 AI Agent 必须首先阅读并遵守这些约束，确保文档始终保持最新和一致。
>
> **文档过时 = 项目管理失败**
