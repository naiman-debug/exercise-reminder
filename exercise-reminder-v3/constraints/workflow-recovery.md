# 工作流恢复约束

> **项目**：exercise-reminder-v3
> **版本**：v1.0
> **创建日期**：2026-01-30
> **适用范围**：所有 AI Agent 会话

---

## 🎯 目的

确保 AI Agent 在新会话中能够快速恢复工作状态，避免重复工作，保持开发连续性。

---

## 📌 规则 1：强制执行 - 启动时读取工作日志

### 触发条件
- 任何新会话启动（包括 `/clear` 后的新会话）
- 用户输入快速恢复命令（见规则 4）

### 执行步骤

```bash
# 1. 读取工作日志最后 20 行
tail -n 20 docs/WORK-LOG.md

# 2. 读取项目知识
head -n 100 docs/KNOWLEDGE-BASE.md
head -n 50 docs/BUG-QUESTION-LOG.md

# 3. 读取工具指南
head -n 80 docs/SKILLS-MCP-GUIDE.md

# 4. 如果文件不存在，提示创建
```

### 自动汇报格式

```
[工作状态恢复]

📌 最后完成：
- 模块：[模块名称]
- 文件：[文件路径]
- 内容：[简要描述完成的功能]
- 时间：[YYYY-MM-DD HH:MM]

📋 下一步：
- 任务：[下一个优先级最高的任务]
- 位置：[文件路径或模块名称]
- 优先级：[P0/P1/P2]

⚠️ 已知问题：
- [来自 BUG-QUESTION-LOG.md 的问题列表]
- [需要避免的已知坑]

🛠️ 可用工具：
- Skills：[本项目使用过的 Skills]
- MCP：[本项目使用过的 MCP 工具]

📊 当前进度：[X]%

是否继续？（输入"继续"开始执行）
```

### 示例

```
[工作状态恢复]

📌 最后完成：
- 模块：数据库层（Database Layer）
- 文件：electron/database/schema.ts, db.ts, queries.ts
- 内容：完成 SQLite 数据库初始化、类型定义、查询类
- 时间：2026-01-30 下午

📋 下一步：
- 任务：实现提醒系统调度器（Reminder Scheduler）
- 位置：electron/reminder/scheduler.ts
- 优先级：P0（最高）

⚠️ 已知问题：
- 数据库列名必须添加别名（snake_case → camelCase）
- main.ts 必须按顺序初始化所有模块
- 不要用 SELECT * + 类型断言

🛠️ 可用工具：
- Skills：test-driven-development, security-review, backend-patterns
- MCP：cclsp（代码导航）、filesystem（文件操作）

📊 当前进度：35%

是否继续？（输入"继续"开始执行）
```

---

## 📌 规则 2：强制执行 - 上下文压缩

### 触发条件（满足任一即触发）

每完成以下任一操作后，**必须立即自动执行** `/compact`：

1. ✅ **完成一个完整模块**（如数据库层、IPC 通信层、UI 组件）
2. ✅ **完成超过 3 个文件的修改**（连续修改多个文件）
3. ✅ **阅读超过 500 行的文档**（阅读大量代码或文档）
4. ✅ **生成超过 100 行的代码**（编写大量代码）

### 执行流程

```bash
# 1. 立即执行压缩命令
/compact

# 2. 等待压缩完成
# 观察系统提示：[2mCompacted (ctrl+o to see full summary)[22m

# 3. 在 WORK-LOG.md 记录
echo "- 🔄 已压缩上下文" >> docs/WORK-LOG.md
```

### 记录格式

在工作日志中添加压缩记录：

```markdown
### 🔄 上下文管理
- **时间**：[HH:MM]
- **操作**：已压缩上下文
- **原因**：[触发原因，如"完成数据库层模块"]
```

### 强制要求

- ⚠️ **不可跳过**：这是强制规则，不允许延迟或跳过
- ⚠️ **等待完成**：必须等待系统提示压缩完成，才能继续后续操作
- ⚠️ **记录在案**：每次压缩都必须在 WORK-LOG.md 中记录
- ⚠️ **主动执行**：AI Agent 应主动判断触发条件，无需用户提醒

### 示例

```
[场景]：完成数据库层 5 个文件的编写

[AI 自动执行]：
1. 检测到已完成 5 个文件修改（>3 个文件阈值）
2. 立即执行：/compact
3. 等待系统提示：[2mCompacted (ctrl+o to see full summary)[22m
4. 在 WORK-LOG.md 记录：
   ### 🔄 上下文管理
   - **时间**：15:30
   - **操作**：已压缩上下文
   - **原因**：完成数据库层 5 个文件（schema.ts, db.ts, queries.ts, migrations.ts, index.ts）
5. 继续后续任务...
```

---

## 📌 规则 3：自动日志更新 - 触发点

### 记录阈值（何时需要记录）

| 操作类型 | 阈值 | 说明 |
|----------|------|------|
| **代码修改** | 修改 ≥3 个文件 或 新增 ≥50 行代码 | 批量修改需要记录 |
| **功能开发** | 耗时 ≥10 分钟 | 一次性完成的任务 |
| **bug 修复** | 任何修复后 | 记录问题和解决方案 |
| **任务暂停** | 会话结束前 | 总结当前进度和待办 |

### 不需要记录的情况

- ❌ 只读操作（查看文件、分析代码）
- ❌ 简单单行修改（修正拼写、格式调整）
- ❌ 询问问题、讨论方案
- ❌ 用户明确说"不用记录"

### 必须更新的时机

#### 3.1 完成任何模块后
- ✅ 完成 HTML 原型页面
- ✅ 完成 TypeScript 模块/类
- ✅ 完成 React 组件
- ✅ 完成 IPC 处理器
- ✅ 完成数据库查询方法

#### 3.2 暂停/切换任务前
- ✅ 用户说"暂停"/"休息"
- ✅ 用户说"下次继续"
- ✅ 用户切换到其他项目
- ✅ 会话即将结束

#### 3.3 重要决策后
- ✅ 架构设计确定
- ✅ 技术选型确定
- ✅ 问题解决方案确定

#### 3.4 任务状态变更 🆕 **新增**
- ✅ 创建新任务（添加到 `docs/TASKS.md`）
- ✅ 任务状态变更（待开始→进行中→等待条件→完成）
- ✅ 子任务完成
- ✅ 进度更新

### 更新内容要求

```markdown

### 更新内容要求

```markdown
## YYYY-MM-DD [时间段]

### ✅ 完成内容
#### N. [模块/功能名称]
- **文件**：`path/to/file`
- **内容**：详细描述
- **技术**：使用的技术/库/方法

### ❌ 待开发部分
#### 1. [模块名]（P0）
- **需要实现**：文件列表
- **功能要求**：详细说明

### 📊 当前进度总览
| 模块 | 状态 | 完成度 | 说明 |
|------|------|--------|------|
| ... | ... | ... | ... |

**总体进度**：约 X%

### 🚀 快速开始（给新 CC 会话）
**当前阶段**：[阶段名称]
**下一步**：[具体任务]
```

### 更新位置
- **文件路径**：`{项目目录}/docs/WORK-LOG.md`
- **插入位置**：文件开头（最新日期在前）
- **保留历史**：不要删除旧日志

---

## 📌 规则 4：快速恢复命令识别

### 触发命令
以下命令必须触发工作流恢复流程：

- `继续`
- `恢复`
- `continue`
- `resume`
- `next`
- `下一步`
- `接着来`

### 识别逻辑

```
IF 用户输入匹配任何快速恢复命令 THEN
    1. 读取 docs/WORK-LOG.md 最后 20 行
    2. 解析最后完成的内容
    3. 识别下一步任务
    4. 显示恢复格式化信息
    5. 等待用户确认
END IF
```

### 恢复响应格式

```
[工作状态恢复]

📌 最后完成：[模块名]
- [简要描述]

📋 下一步：[待开发首项]
- 优先级：[P0/P1/P2]
- 位置：[路径]

🛠️ 工具：[MCP/Skills]

📊 当前进度：[X]%

---
是否继续下一步？
[输入"继续"开始执行，或输入其他指令]
```

---

## 📌 规则 5：恢复后的执行流程

### 用户确认后执行

```
1. 显示详细任务说明
   ├─ 任务目标
   ├─ 技术要求
   └─ 验证标准

2. 准备开发环境
   ├─ 检查依赖
   ├─ 创建目录（如需要）
   └─ 读取相关文件

3. 开始执行
   ├─ 调用相关技能
   ├─ 编写代码
   └─ 测试验证

4. 完成后更新日志
   └─ 按规则 2 更新 WORK-LOG.md
```

### 示例执行流程

```
[用户输入]：继续

[AI 响应]：
✅ 收到确认，开始执行任务！

📋 任务：实现提醒系统调度器
📍 位置：electron/reminder/scheduler.ts

🎯 任务目标：
1. 创建 ReminderScheduler 类
2. 管理三个独立时间线（运动、远眺、站立）
3. 实现随机间隔触发逻辑
4. 集成暂停/恢复功能

🛠️ 使用技能：
- brainstorming（细化需求）
- writing-plans（编写实现计划）
- executing-plans（执行实现）

⏳ 开始执行...
```

---

## 📌 规则 6：日志格式验证

### 必须包含的章节

每个日志条目必须包含：

- ✅ **✅ 完成内容**：已完成的任务列表
- ✅ **❌ 待开发部分**：未完成的任务（按优先级）
- ✅ **📊 当前进度总览**：进度表格 + 总体百分比
- ✅ **🚀 快速开始**：给新会话的快速指南

### 推荐包含的章节

- 🛠️ **可用的开发工具和技能**
- 📁 **项目文件结构**
- 🔗 **相关文档链接**

### 格式检查清单

```markdown
## YYYY-MM-DD [时间段]          # ✅ 日期标题
### ✅ 完成内容                  # ✅ 完成章节
#### N. 任务名                   # ✅ 任务序号
- **文件**：`path`              # ✅ 文件路径
- **内容**：描述                 # ✅ 内容描述
### ❌ 待开发部分                # ✅ 待开发章节
#### 1. 模块（P0）               # ✅ 优先级标记
### 📊 当前进度总览              # ✅ 进度总览
| 模块 | 状态 | 完成度 |        # ✅ 进度表格
**总体进度**：约 X%              # ✅ 总体百分比
```

---

## 📌 规则 7：异常处理

### 场景 1：工作日志不存在

```
[错误]
❌ 未找到工作日志文件：docs/WORK-LOG.md

[解决方案]
1. 检查项目是否有 docs/ 目录
2. 创建初始工作日志
3. 从现有代码推断当前进度

[执行]
是否创建初始工作日志？（输入"是"创建）
```

### 场景 2：工作日志为空

```
[警告]
⚠️ 工作日志文件存在但为空

[可能原因]
- 项目刚开始
- 日志被意外清空

[解决方案]
1. 扫描项目文件结构
2. 推断当前进度
3. 生成初始日志

[执行]
是否生成初始工作日志？（输入"是"生成）
```

### 场景 3：无法解析进度

```
[警告]
⚠️ 无法从工作日志解析当前进度

[原因]
- 日志格式不符合规范
- 缺少关键信息

[解决方案]
1. 手动指定当前任务
2. 重新格式化日志
3. 继续执行（跳过恢复）

[执行]
选择处理方式：
[1] 手动指定任务
[2] 重新格式化日志
[3] 跳过恢复，直接开始
```

---

## 📌 规则 8：测试验证

### 功能测试

每次更新工作流恢复机制后，必须进行以下测试：

#### 测试 1：基本恢复流程
```bash
# 1. 创建新的会话
# 2. 输入："继续"
# 3. 验证：是否显示正确的恢复信息
```

#### 测试 2：日志不存在
```bash
# 1. 删除或重命名 WORK-LOG.md
# 2. 输入："继续"
# 3. 验证：是否提示创建日志
```

#### 测试 3：快速恢复命令
```bash
# 1. 依次测试所有恢复命令
#    - 继续
#    - 恢复
#    - continue
#    - resume
#    - next
#    - 下一步
#    - 接着来
# 2. 验证：所有命令都触发恢复流程
```

#### 测试 4：日志更新触发
```bash
# 1. 完成一个小任务（如创建文件）
# 2. 验证：是否自动更新日志
# 3. 检查：更新格式是否正确
```

---

## 📌 规则 9：持续改进

### 定期审查
- 每周审查恢复流程的有效性
- 收集用户反馈
- 优化响应格式

### 版本更新
- 记录每次修改
- 更新版本号
- 保持向后兼容

---

## 📌 规则 10：强制更新知识库

### 触发条件

满足以下任一条件时，**必须立即更新**对应的知识库文档：

1. **遇到新的问题或 bug**
   - 更新文档：`docs/BUG-QUESTION-LOG.md`

2. **学到新的经验或教训**
   - 更新文档：`docs/KNOWLEDGE-BASE.md`
   - 更新文档：`docs/BUG-QUESTION-LOG.md`（经验教训部分）

3. **使用新的 Skill 或 MCP 工具**
   - 更新文档：`docs/SKILLS-MCP-GUIDE.md`
   - 记录使用场景、效果、建议

4. **改进工作流程**
   - 更新文档：`docs/WORKFLOW-EVOLUTION.md`
   - 记录原因、方案、效果

### 更新内容要求

每个更新必须包含：

#### 对于 Bug/问题：
- ✅ 问题描述
- ✅ 排查过程
- ✅ 解决方案
- ✅ 经验教训

#### 对于经验：
- ✅ 场景描述
- ✅ 解决方案
- ✅ 适用条件
- ✅ 注意事项

#### 对于工具：
- ✅ 使用场景
- ✅ 实际效果
- ✅ 对比分析
- ✅ 推荐指数

#### 对于流程改进：
- ✅ 改进原因
- ✅ 改进方案
- ✅ 效果对比
- ✅ 指标变化

### 执行方式

```bash
# 立即更新（不允许延迟）
# 更新后添加到 WORK-LOG.md
echo "- 📝 已更新知识库文档：docs/XXX.md" >> docs/WORK-LOG.md
```

### 相关文档映射

| 触发条件 | 更新文档 |
|----------|----------|
| Bug/问题 | `docs/BUG-QUESTION-LOG.md` |
| 新经验 | `docs/KNOWLEDGE-BASE.md` |
| 新工具 | `docs/SKILLS-MCP-GUIDE.md` |
| 流程改进 | `docs/WORKFLOW-EVOLUTION.md` |

---

## 📌 规则 11：开发完成后强制测试 ⭐ **新增**

### 触发条件

完成以下任一操作后，**必须立即执行**强制测试验证：

1. ✅ **完成一个完整模块**（如数据库层、IPC 通信层、UI 组件）
2. ✅ **完成超过 3 个文件的修改**（连续修改多个文件）
3. ✅ **修复一个 bug**（bug 修复后必须验证）
4. ✅ **添加新功能**（任何功能实现后）

### 强制测试流程

```bash
# 1. 必须使用 test-driven-development skill
/skill test-driven-development

# 2. 根据模块类型使用其他审查 skills
- 安全相关：/skill security-review
- 后端代码：/skill backend-patterns
- 前端代码：/skill frontend-design

# 3. 执行测试
npm test                    # 运行单元测试
npm run test:integration   # 运行集成测试（如有）

# 4. 验证通过标准
# 所有测试必须通过才能标记"完成"
```

### 必须使用的测试 Skills

| Skill | 适用场景 | 触发条件 |
|-------|----------|----------|
| `test-driven-development` | 所有模块 | **强制** - 完成任何开发后 |
| `security-review` | 处理用户输入、认证、API、敏感数据 | **强制** - 涉及安全功能 |
| `backend-patterns` | API 路由、数据库查询、服务层 | **强制** - 后端代码 |
| `requesting-code-review` | 完成重大功能 | **推荐** - 提交前审查 |

### 测试通过标准

#### 标准通过条件
- ✅ 所有单元测试通过（100%）
- ✅ 无 TypeScript 类型错误
- ✅ 无 ESLint 警告
- ✅ 安全审查通过（如适用）
- ✅ 代码审查通过（如适用）

#### 测试报告格式

```markdown
### 🧪 测试验证报告
- **时间**：[YYYY-MM-DD HH:MM]
- **测试模块**：[模块名称]
- **测试类型**：单元测试 / 集成测试 / 安全审查

#### 测试结果
| 测试项 | 状态 | 说明 |
|--------|------|------|
| 单元测试 | ✅ 通过 | 15/15 tests passed |
| 类型检查 | ✅ 通过 | No TypeScript errors |
| 代码规范 | ✅ 通过 | No ESLint warnings |
| 安全审查 | ✅ 通过 | No vulnerabilities found |

#### 使用的 Skills
- test-driven-development
- security-review
- backend-patterns

#### 结论
✅ **测试全部通过，可以标记为"完成"**
```

#### 不通过处理

```
IF 测试未通过 THEN
    1. 记录失败的测试项
    2. 分析失败原因
    3. 修复问题
    4. 重新测试
    5. 直到全部通过
END IF

⚠️ 不允许跳过测试或标记为"临时完成"
```

### 执行示例

```
[场景]：完成数据库层 5 个文件的编写

[AI 自动执行]：
1. 检测到已完成数据库层模块开发
2. 立即调用：test-driven-development skill
3. 编写/运行测试：
   - npm test
   - 检查测试覆盖率
4. 调用：security-review skill（数据库安全）
5. 调用：backend-patterns skill（架构审查）
6. 生成测试报告
7. IF 全部通过 THEN
       标记为"完成"
       更新 WORK-LOG.md
   ELSE
       修复问题
       重新测试
   END IF
```

---

## 🔗 相关文档

- **工作日志**：`docs/WORK-LOG.md`
- **知识库**：`docs/KNOWLEDGE-BASE.md`
- **Bug 日志**：`docs/BUG-QUESTION-LOG.md`
- **工具手册**：`docs/SKILLS-MCP-GUIDE.md`
- **演进历史**：`docs/WORKFLOW-EVOLUTION.md`
- **知识库更新触发**：`constraints/knowledge-update-triggers.md` ⭐
- **工作流程规范**：`F:\claude-code\AGENTS.md`
- **文件组织规范**：`F:\claude-code\.global\rules\FILE_ORGANIZATION_RULES.md`

---

## 📝 版本历史

- **v1.3** (2026-01-30) - 添加开发完成后强制测试规则
  - 新增规则 11：开发完成后强制测试
  - 定义 4 种触发测试的条件
  - 规范必须使用的测试 Skills
  - 定义测试通过标准和报告格式

- **v1.2** (2026-01-30) - 添加知识库更新规则
  - 新增规则 10：强制更新知识库
  - 定义 4 种触发条件和对应文档
  - 规范更新内容要求
  - 建立文档映射关系

- **v1.1** (2026-01-30) - 添加上下文压缩规则
  - 新增规则 2：强制执行上下文压缩
  - 定义 4 种触发条件
  - 规范压缩后的记录格式
  - 所有规则编号重新调整

- **v1.0** (2026-01-30) - 初始版本
  - 定义 8 条核心规则
  - 建立恢复流程
  - 规范日志格式

---

> ⚠️ **重要提示**：这些规则是强制性的，不是可选项！
>
> 每次会话启动时，AI Agent 必须首先执行工作流恢复流程，然后再处理用户的其他请求。
