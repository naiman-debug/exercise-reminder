# 工作流恢复约束

> **项目**：exercise-reminder-v3
> **版本**：v1.0
> **创建日期**：2026-01-30
> **适用范围**：所有 AI Agent 会话

---

## 🎯 目的

确保 AI Agent 在新会话中能够快速恢复工作状态，避免重复工作，保持开发连续性。

---

## 📌 规则 1：强制执行 - 启动时读取工作日志

### 触发条件
- 任何新会话启动（包括 `/clear` 后的新会话）
- 用户输入快速恢复命令（见规则 3）

### 执行步骤

```bash
# 1. 读取工作日志最后 20 行
tail -n 20 docs/WORK-LOG.md

# 2. 如果文件不存在，提示创建
# 3. 如果文件存在且为空，提示检查历史记录
```

### 自动汇报格式

```
[工作状态恢复]

📌 最后完成：
- 模块：[模块名称]
- 文件：[文件路径]
- 内容：[简要描述完成的功能]
- 时间：[YYYY-MM-DD HH:MM]

📋 下一步：
- 任务：[下一个优先级最高的任务]
- 位置：[文件路径或模块名称]
- 优先级：[P0/P1/P2]

🛠️ 使用工具：
- MCP：[MCP 工具名称]
- Skills：[技能名称]

📊 当前进度：[X]%

是否继续？（输入"继续"开始执行）
```

### 示例

```
[工作状态恢复]

📌 最后完成：
- 模块：数据库层（Database Layer）
- 文件：electron/database/schema.ts, db.ts, queries.ts
- 内容：完成 SQLite 数据库初始化、类型定义、查询类
- 时间：2026-01-30 下午

📋 下一步：
- 任务：实现提醒系统调度器（Reminder Scheduler）
- 位置：electron/reminder/scheduler.ts
- 优先级：P0（最高）

🛠️ 使用工具：
- MCP：mcp__cclsp__find_definition（代码导航）
- Skills：brainstorming（需求细化）、writing-plans（编写计划）

📊 当前进度：35%

是否继续？（输入"继续"开始执行）
```

---

## 📌 规则 2：强制执行 - 上下文压缩

### 触发条件（满足任一即触发）

每完成以下任一操作后，**必须立即自动执行** `/compact`：

1. ✅ **完成一个完整模块**（如数据库层、IPC 通信层、UI 组件）
2. ✅ **完成超过 3 个文件的修改**（连续修改多个文件）
3. ✅ **阅读超过 500 行的文档**（阅读大量代码或文档）
4. ✅ **生成超过 100 行的代码**（编写大量代码）

### 执行流程

```bash
# 1. 立即执行压缩命令
/compact

# 2. 等待压缩完成
# 观察系统提示：[2mCompacted (ctrl+o to see full summary)[22m

# 3. 在 WORK-LOG.md 记录
echo "- 🔄 已压缩上下文" >> docs/WORK-LOG.md
```

### 记录格式

在工作日志中添加压缩记录：

```markdown
### 🔄 上下文管理
- **时间**：[HH:MM]
- **操作**：已压缩上下文
- **原因**：[触发原因，如"完成数据库层模块"]
```

### 强制要求

- ⚠️ **不可跳过**：这是强制规则，不允许延迟或跳过
- ⚠️ **等待完成**：必须等待系统提示压缩完成，才能继续后续操作
- ⚠️ **记录在案**：每次压缩都必须在 WORK-LOG.md 中记录
- ⚠️ **主动执行**：AI Agent 应主动判断触发条件，无需用户提醒

### 示例

```
[场景]：完成数据库层 5 个文件的编写

[AI 自动执行]：
1. 检测到已完成 5 个文件修改（>3 个文件阈值）
2. 立即执行：/compact
3. 等待系统提示：[2mCompacted (ctrl+o to see full summary)[22m
4. 在 WORK-LOG.md 记录：
   ### 🔄 上下文管理
   - **时间**：15:30
   - **操作**：已压缩上下文
   - **原因**：完成数据库层 5 个文件（schema.ts, db.ts, queries.ts, migrations.ts, index.ts）
5. 继续后续任务...
```

---

## 📌 规则 3：自动日志更新 - 触发点

### 必须更新的时机

#### 3.1 完成任何模块后
- ✅ 完成 HTML 原型页面
- ✅ 完成 TypeScript 模块/类
- ✅ 完成 React 组件
- ✅ 完成 IPC 处理器
- ✅ 完成数据库查询方法

#### 3.2 暂停/切换任务前
- ✅ 用户说"暂停"/"休息"
- ✅ 用户说"下次继续"
- ✅ 用户切换到其他项目
- ✅ 会话即将结束

#### 3.3 重要决策后
- ✅ 架构设计确定
- ✅ 技术选型确定
- ✅ 问题解决方案确定

### 更新内容要求

```markdown
## YYYY-MM-DD [时间段]

### ✅ 完成内容
#### N. [模块/功能名称]
- **文件**：`path/to/file`
- **内容**：详细描述
- **技术**：使用的技术/库/方法

### ❌ 待开发部分
#### 1. [模块名]（P0）
- **需要实现**：文件列表
- **功能要求**：详细说明

### 📊 当前进度总览
| 模块 | 状态 | 完成度 | 说明 |
|------|------|--------|------|
| ... | ... | ... | ... |

**总体进度**：约 X%

### 🚀 快速开始（给新 CC 会话）
**当前阶段**：[阶段名称]
**下一步**：[具体任务]
```

### 更新位置
- **文件路径**：`{项目目录}/docs/WORK-LOG.md`
- **插入位置**：文件开头（最新日期在前）
- **保留历史**：不要删除旧日志

---

## 📌 规则 4：快速恢复命令识别

### 触发命令
以下命令必须触发工作流恢复流程：

- `继续`
- `恢复`
- `continue`
- `resume`
- `next`
- `下一步`
- `接着来`

### 识别逻辑

```
IF 用户输入匹配任何快速恢复命令 THEN
    1. 读取 docs/WORK-LOG.md 最后 20 行
    2. 解析最后完成的内容
    3. 识别下一步任务
    4. 显示恢复格式化信息
    5. 等待用户确认
END IF
```

### 恢复响应格式

```
[工作状态恢复]

📌 最后完成：[模块名]
- [简要描述]

📋 下一步：[待开发首项]
- 优先级：[P0/P1/P2]
- 位置：[路径]

🛠️ 工具：[MCP/Skills]

📊 当前进度：[X]%

---
是否继续下一步？
[输入"继续"开始执行，或输入其他指令]
```

---

## 📌 规则 5：恢复后的执行流程

### 用户确认后执行

```
1. 显示详细任务说明
   ├─ 任务目标
   ├─ 技术要求
   └─ 验证标准

2. 准备开发环境
   ├─ 检查依赖
   ├─ 创建目录（如需要）
   └─ 读取相关文件

3. 开始执行
   ├─ 调用相关技能
   ├─ 编写代码
   └─ 测试验证

4. 完成后更新日志
   └─ 按规则 2 更新 WORK-LOG.md
```

### 示例执行流程

```
[用户输入]：继续

[AI 响应]：
✅ 收到确认，开始执行任务！

📋 任务：实现提醒系统调度器
📍 位置：electron/reminder/scheduler.ts

🎯 任务目标：
1. 创建 ReminderScheduler 类
2. 管理三个独立时间线（运动、远眺、站立）
3. 实现随机间隔触发逻辑
4. 集成暂停/恢复功能

🛠️ 使用技能：
- brainstorming（细化需求）
- writing-plans（编写实现计划）
- executing-plans（执行实现）

⏳ 开始执行...
```

---

## 📌 规则 6：日志格式验证

### 必须包含的章节

每个日志条目必须包含：

- ✅ **✅ 完成内容**：已完成的任务列表
- ✅ **❌ 待开发部分**：未完成的任务（按优先级）
- ✅ **📊 当前进度总览**：进度表格 + 总体百分比
- ✅ **🚀 快速开始**：给新会话的快速指南

### 推荐包含的章节

- 🛠️ **可用的开发工具和技能**
- 📁 **项目文件结构**
- 🔗 **相关文档链接**

### 格式检查清单

```markdown
## YYYY-MM-DD [时间段]          # ✅ 日期标题
### ✅ 完成内容                  # ✅ 完成章节
#### N. 任务名                   # ✅ 任务序号
- **文件**：`path`              # ✅ 文件路径
- **内容**：描述                 # ✅ 内容描述
### ❌ 待开发部分                # ✅ 待开发章节
#### 1. 模块（P0）               # ✅ 优先级标记
### 📊 当前进度总览              # ✅ 进度总览
| 模块 | 状态 | 完成度 |        # ✅ 进度表格
**总体进度**：约 X%              # ✅ 总体百分比
```

---

## 📌 规则 7：异常处理

### 场景 1：工作日志不存在

```
[错误]
❌ 未找到工作日志文件：docs/WORK-LOG.md

[解决方案]
1. 检查项目是否有 docs/ 目录
2. 创建初始工作日志
3. 从现有代码推断当前进度

[执行]
是否创建初始工作日志？（输入"是"创建）
```

### 场景 2：工作日志为空

```
[警告]
⚠️ 工作日志文件存在但为空

[可能原因]
- 项目刚开始
- 日志被意外清空

[解决方案]
1. 扫描项目文件结构
2. 推断当前进度
3. 生成初始日志

[执行]
是否生成初始工作日志？（输入"是"生成）
```

### 场景 3：无法解析进度

```
[警告]
⚠️ 无法从工作日志解析当前进度

[原因]
- 日志格式不符合规范
- 缺少关键信息

[解决方案]
1. 手动指定当前任务
2. 重新格式化日志
3. 继续执行（跳过恢复）

[执行]
选择处理方式：
[1] 手动指定任务
[2] 重新格式化日志
[3] 跳过恢复，直接开始
```

---

## 📌 规则 8：测试验证

### 功能测试

每次更新工作流恢复机制后，必须进行以下测试：

#### 测试 1：基本恢复流程
```bash
# 1. 创建新的会话
# 2. 输入："继续"
# 3. 验证：是否显示正确的恢复信息
```

#### 测试 2：日志不存在
```bash
# 1. 删除或重命名 WORK-LOG.md
# 2. 输入："继续"
# 3. 验证：是否提示创建日志
```

#### 测试 3：快速恢复命令
```bash
# 1. 依次测试所有恢复命令
#    - 继续
#    - 恢复
#    - continue
#    - resume
#    - next
#    - 下一步
#    - 接着来
# 2. 验证：所有命令都触发恢复流程
```

#### 测试 4：日志更新触发
```bash
# 1. 完成一个小任务（如创建文件）
# 2. 验证：是否自动更新日志
# 3. 检查：更新格式是否正确
```

---

## 📌 规则 9：持续改进

### 定期审查
- 每周审查恢复流程的有效性
- 收集用户反馈
- 优化响应格式

### 版本更新
- 记录每次修改
- 更新版本号
- 保持向后兼容

---

## 🔗 相关文档

- **工作日志**：`docs/WORK-LOG.md`
- **工作流程规范**：`F:\claude-code\AGENTS.md`
- **文件组织规范**：`F:\claude-code\.global\rules\FILE_ORGANIZATION_RULES.md`

---

## 📝 版本历史

- **v1.1** (2026-01-30) - 添加上下文压缩规则
  - 新增规则 2：强制执行上下文压缩
  - 定义 4 种触发条件
  - 规范压缩后的记录格式
  - 所有规则编号重新调整

- **v1.0** (2026-01-30) - 初始版本
  - 定义 8 条核心规则
  - 建立恢复流程
  - 规范日志格式

---

> ⚠️ **重要提示**：这些规则是强制性的，不是可选项！
>
> 每次会话启动时，AI Agent 必须首先执行工作流恢复流程，然后再处理用户的其他请求。
