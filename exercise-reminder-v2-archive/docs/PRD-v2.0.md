# PRD v2.0 - "灵动休息"健康助手

**产品名称**：灵动休息健康助手
**版本**：v2.0
**日期**：2026-01-27
**状态**：开发中

---

## 一、 产品概述

### 1.1 产品定位

Windows 桌面久坐提醒应用，通过随机间隔的强制倒计时提醒，帮助用户养成定时站立、运动、远眺的健康习惯。

### 1.2 目标用户

- 久坐办公人群（程序员、设计师、文案等）
- 长时间使用电脑的创作者
- 需要定时休息提醒的自由职业者

### 1.3 核心价值

1. **科学健康**：基于 MET 值计算热量消耗，量化健康收益
2. **强制有效**：全屏倒计时不可关闭，确保休息执行
3. **友好设计**：呼吸感设计语言，柔和有机的视觉体验
4. **数据驱动**：统计页面展示活动数据，激励持续使用

### 1.4 v2.0 更新要点

- ✅ 去掉惩罚机制（v1.0 的连续跳过惩罚）
- ✅ 所有提醒改为纯倒计时自动结束
- ✅ 新增统计页面（今日统计 + 本周图表）
- ✅ 呼吸感设计系统（DesignTokens）
- ✅ 首次启动向导（4 页流程）

---

## 二、 核心功能模块

### 2.1 随机提醒机制

**功能描述**：三种类型的提醒在随机时间间隔触发

**提醒类型**：

| 类型 | 默认间隔 | 随机偏移 | 执行时长 |
|------|---------|---------|---------|
| 强制站立 | 30-60 分钟 | ±15 分钟 | 90 秒 |
| 微运动 | 45-75 分钟 | ±15 分钟 | 30-60 秒 |
| 强制远眺 | 60-90 分钟 | ±15 分钟 | 60 秒 |

**交互流程**：
1. 定时器到达触发时间
2. 弹出全屏倒计时窗口
3. 倒计时自动归零
4. 显示完成反馈（1 秒）
5. 窗口自动关闭
6. 记录活动数据
7. 进入 2 分钟冷却期

**技术实现**：
- `ReminderEngine` (src/core/reminder_engine.py)
- `StandDialog`, `ExerciseDialog`, `GazeDialog` (src/ui/dialogs/)
- 随机间隔算法：`interval_avg + random.uniform(-offset, +offset)`

---

### 2.2 强制倒计时提醒

**功能描述**：全屏弹窗 + 大字体倒计时 + 自动结束

**设计规格**：

| 元素 | 规格 |
|------|------|
| 窗口尺寸 | 800 x 600 px |
| 倒计时字体 | 96-120 pt, Consolas 等宽字体 |
| 背景色 | 白色 (#FFFFFF) |
| 倒计时颜色 | 绿色→黄色→橙色→红色（渐变） |

**倒计时颜色规则**：

| 剩余时间 | 颜色 | Hex |
|---------|------|-----|
| > 50% | 绿色 | #4CAF50 |
| 30-50% | 黄色 | #FFC107 |
| < 30% | 橙色 | #FF9800 |
| < 10 秒 | 红色闪烁 | #F44336 |

**三种提醒的差异**：

| 提醒类型 | 交互特点 | 完成反馈 |
|---------|---------|----------|
| 站立 | 静态提示："请站立" | ✅ 完成 |
| 微运动 | 显示动作名称 + 热量消耗 | ✅ 完成！消耗 XX 千卡 |
| 远眺 | 静态提示："请远眺" | ✅ 完成 |

**技术实现**：
- 基类：`BaseReminderDialog` (src/ui/dialogs/base_dialog.py)
- 子类：`StandDialog`, `ExerciseDialog`, `GazeDialog`
- 完成/跳过按钮已移除，纯倒计时自动结束

---

### 2.3 数据记录与统计

**功能描述**：记录所有活动数据，支持统计查询

**数据模型**：

| 表名 | 字段 | 说明 |
|------|------|------|
| activity_logs | activity_type | stand / exercise / gaze |
| activity_logs | duration_seconds | 活动时长（秒） |
| activity_logs | calories_burned | 消耗热量（千卡） |
| activity_logs | completed | 是否完成 |
| activity_logs | skipped | 是否跳过 |
| activity_logs | timestamp | 活动时间戳 |

**今日统计**（显示在统计页面）：

```
🔥 今日消耗:  185 kcal
✅ 完成次数:  5 次
⏱️  总时长:  10 分钟
```

**本周统计**（显示在统计页面）：

- 7 日热量消耗趋势图（折线图）
- 总消耗：1,250 kcal
- 平均每天：178 kcal

**技术实现**：
- `ActivityLog` 模型 (src/models/models.py)
- `ActivityRepository` (src/models/repositories.py)
- 数据查询方法：
  - `get_today_stats()` - 今日统计
  - `get_calories_last_7_days()` - 7 天热量数据
  - `get_recent_activities(limit)` - 最近活动记录

---

### 2.4 MET 热量计算

**功能描述**：基于 MET 值科学计算运动热量消耗

**计算公式**：

```
热量(千卡) = MET × 3.5 × 体重(kg) / 200 × 时长(分钟)
```

**默认动作库**（10 个动作）：

| 动作名称 | 时长 | MET 值 | 强度 |
|---------|------|--------|------|
| 开合跳 | 30 秒 | 6.0 | 中等强度 |
| 自重深蹲 | 45 秒 | 6.0 | 中等强度 |
| 高抬腿 | 30 秒 | 6.0 | 中等强度 |
| 原地踏步 | 60 秒 | 6.0 | 中等强度 |
| 靠墙静蹲 | 45 秒 | 6.0 | 中等强度 |
| 手臂画圈 | 30 秒 | 6.0 | 中等强度 |
| 简化波比跳 | 30 秒 | 8.0 | 高强度 |
| 登山跑 | 30 秒 | 8.0 | 高强度 |
| 哑铃推举 | 45 秒 | 6.0 | 中等强度 |
| 弹力绳划船 | 45 秒 | 6.0 | 中等强度 |

**技术实现**：
- `METCalculator` (src/utils/met_calculator.py)
- `Exercise` 模型（met_value 字段）

---

## 三、 辅助功能模块

### 3.1 首次启动向导

**功能描述**：新用户首次启动时引导完成基础设置

**向导流程**（4 页）：

| 页面 | 标题 | 内容 |
|------|------|------|
| 第 1 页 | 欢迎使用 | 产品介绍 + 开始按钮 |
| 第 2 页 | 个人信息 | 体重输入（用于热量计算） |
| 第 3 页 | 提醒设置 | 站立/运动/远眺的间隔和时长 |
| 第 4 页 | 准备就绪 | 10 秒倒计时 + 体验提示 |

**技术实现**：
- `FirstRunWizard` (src/ui/wizards/first_run_wizard.py)
- 基于 QWizard
- 10 秒倒计时自动进入下一步

---

### 3.2 设置对话框

**功能描述**：5 个标签页，涵盖所有配置项

**标签页结构**：

| 标签页 | 功能 |
|--------|------|
| 提醒设置 | 三种提醒的间隔、时长开关 |
| 用户信息 | 体重修改、目标设置 |
| 动作库 | 查看、添加、删除动作 |
| 统计 | 今日统计、本周图表 |
| 基础设置 | 开机启动、音效、音量 |

**技术实现**：
- `SettingsDialog` (src/ui/settings/settings_dialog.py)
- 基于 QTabWidget
- 配置存储：Setting 模型（key-value 结构）

---

### 3.3 主窗口

**功能描述**：统计信息 + 快速操作入口

**窗口内容**：

| 模块 | 内容 |
|------|------|
| 目标进度 | 运动热量目标进度条、连续打卡天数 |
| 活动详情 | 今日活动列表（滚动） |
| 快速操作 | 动作库、参数设置、用户信息、基础设置 |

**技术实现**：
- `MainWindow` (src/ui/main_window.py)
- 30 秒自动刷新数据
- 900 x 550 px 窗口尺寸

---

### 3.4 音频播放

**功能描述**：提醒音效 + 可选 TTS 语音播报

**音频类型**：

| 类型 | 说明 |
|------|------|
| 提醒音 | 倒计时开始时播放 |
| 完成音 | 倒计时结束时播放 |
| TTS 语音 | 倒计时最后 5 秒播报（可选） |

**技术实现**：
- `AudioManager` (src/utils/audio_player.py)
- 基于 QSoundEffect
- 音量控制：0.0 - 1.0

---

## 四、 技术特性

### 4.1 呼吸感设计系统

**功能描述**：统一的视觉设计语言

**设计令牌（DesignTokens）**：

| 类别 | 包含内容 |
|------|----------|
| 颜色 | 主色、辅助色、成功色、背景色、文本色 |
| 间距 | XS(4px), SM(8px), MD(16px), LG(24px), XL(32px) |
| 圆角 | SM(4px), MD(8px), LG(16px), XL(24px) |
| 排版 | TEXT_XS(10pt) ~ TEXT_3XL(32pt) |

**技术实现**：
- `DesignTokens` (src/ui/design/tokens.py)
- 统一样式表应用：`DesignTokens.apply_stylesheet(widget, "all")`

---

### 4.2 数据存储

**功能描述**：本地 SQLite 数据库

**数据库路径**：`data/app.db`

**表结构**：

| 表名 | 说明 |
|------|------|
| settings | 配置键值对 |
| exercises | 动作库 |
| exercise_plans | 运动方案（未使用） |
| plan_exercises | 方案-动作关联（未使用） |
| activity_logs | 活动记录 |
| user_profile | 用户档案 |

**技术实现**：
- 基于 Peewee ORM
- WAL 模式 + 64MB 缓存
- 外键约束启用

---

### 4.3 日志系统

**功能描述**：统一的日志记录

**日志级别**：DEBUG, INFO, WARNING, ERROR

**日志输出**：
- 控制台：彩色输出
- 文件：`data/logs/app.log`
- 轮转：10 MB 自动轮转
- 保留：30 天

**技术实现**：
- 基于 loguru
- `get_logger(name)` 获取命名 logger
- `setup_logger()` 初始化配置

---

## 五、 非功能性需求

### 5.1 性能

- 应用启动时间 < 3 秒
- 提醒弹窗响应时间 < 100 ms
- 数据库查询 < 50 ms

### 5.2 兼容性

- Windows 10/11
- Python 3.10+
- PySide6 (Qt 6.x)

### 5.3 可靠性

- 崩溃率 < 0.1%
- 数据丢失率 = 0%
- 提醒准确率 > 99%

---

## 六、 开发状态

### 6.1 已完成功能 ✅

| 功能 | 状态 | 文件 |
|------|------|------|
| 随机提醒机制 | ✅ | reminder_engine.py |
| 三种倒计时弹窗 | ✅ | dialogs/ |
| MET 热量计算 | ✅ | met_calculator.py |
| 数据记录 | ✅ | repositories.py |
| 首次启动向导 | ✅ | wizards/ |
| 主窗口 UI | ✅ | main_window.py |
| 呼吸感设计系统 | ✅ | design/tokens.py |
| 日志系统 | ✅ | logger.py |
| 去掉惩罚机制 | ✅ | 已删除 punishment_logic.py |
| 统计页面（今日统计） | ✅ | statistics/stats_view.py |
| 统计页面（本周图表） | ✅ | statistics/weekly_chart.py |
| 提醒冷却机制 | ✅ | reminder_engine.py (2分钟冷却期) |
| 设置对话框 UI 优化 | ✅ | settings_dialog.py (呼吸感样式) |
| 动作库 CRUD 界面 | ✅ | exercise_library.py (完整CRUD) |
| TTS 语音播报集成 | ✅ | audio_player.py (pyttsx3 + API支持) |

### 6.2 所有功能已完成 ✅

v2.0 所有计划功能已实现，可以交付用户测试。

### 6.3 测试覆盖

**单元测试**：118/118 通过 ✅

**测试文件**：
- test_full_suite.py - 核心功能测试
- test_ui_automation.py - UI 自动化测试
- test_main_window.py - 主窗口测试
- test_first_run_wizard.py - 向导测试
- test_logger.py - 日志系统测试
- test_statistics_view.py - 统计页面测试
- test_cooldown_mechanism.py - 冷却机制测试
- test_tts_manager.py - TTS 语音播报测试

---

## 七、 相关文档

- [UI 设计文档](DESIGN-UI-001.md) - 页面设计规范
- [交互设计文档](DESIGN-IxD-001.md) - 交互流程设计
- [技术架构文档](DESIGN-ARCH-001.md) - 系统架构设计
- [v2.0 UI 重构计划](plans/2026-01-27-v2-ui-redesign.md) - 实现计划

---

## 八、 变更历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| v2.0 | 2026-01-27 | 去掉惩罚机制、新增统计页面、呼吸感设计 |
| v1.0 | 2026-01-20 | 初始版本，包含核心提醒功能 |

---

**文档维护**：Claude Code
**最后更新**：2026-01-27
